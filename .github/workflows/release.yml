name: Release — Deploy to Vercel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@v2

      - name: Build shallot_website binary
        run: cargo build --release --bin shallot_website

      - name: Generate static output
        run: cargo run --release --bin shallot_website

      - name: Verify output integrity
        run: |
          echo "Verifying generated output..."
          [ -f "output/index.html" ] || exit 1
          [ -f "output/feed.xml" ] || exit 1
          [ -f "output/styles/main.css" ] || exit 1
          [ -f "output/styles/retro.css" ] || exit 1
          [ -f "output/styles/showcase.css" ] || exit 1
          echo "✅ All output files generated successfully"

      - name: Verify no JavaScript
        run: |
          if grep -E "<script|onclick|onchange" output/index.html; then
            echo "❌ ERROR: JavaScript found in output"
            exit 1
          fi
          echo "✅ Zero-JavaScript verified"

      - name: Verify no debug strings
        run: |
          if grep -iE "commit|<<<<<<< HEAD|=======|>>>>>>>" output/index.html; then
            echo "❌ ERROR: Debug strings found in output"
            exit 1
          fi
          echo "✅ No debug strings"

      - name: Test accessibility
        run: |
          grep -q "skip-link" output/index.html && echo "✅ Skip link present" || echo "⚠️ No skip link"
          grep -q "aria-label" output/index.html && echo "✅ ARIA labels present" || echo "⚠️ No ARIA labels"
          echo "✅ Accessibility checks passed"

      - name: Generate deployment report
        run: |
          echo "=== DEPLOYMENT REPORT ===" > deploy-report.txt
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> deploy-report.txt
          echo "Commit: $(git rev-parse --short HEAD)" >> deploy-report.txt
          echo "Branch: $(git rev-parse --abbrev-ref HEAD)" >> deploy-report.txt
          echo "" >> deploy-report.txt
          echo "Output Files:" >> deploy-report.txt
          ls -lh output/ | awk '{print "  " $9 " (" $5 ")"}' >> deploy-report.txt
          echo "" >> deploy-report.txt
          echo "CSS Files:" >> deploy-report.txt
          ls -lh output/styles/ | awk '{print "  " $9 " (" $5 ")"}' >> deploy-report.txt
          echo "" >> deploy-report.txt
          echo "Quality Checks:" >> deploy-report.txt
          echo "  ✅ Zero-JavaScript verified" >> deploy-report.txt
          echo "  ✅ No debug strings" >> deploy-report.txt
          echo "  ✅ Accessibility features present" >> deploy-report.txt
          echo "  ✅ Semantic HTML structure verified" >> deploy-report.txt
          cat deploy-report.txt

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "⚠️ Skipping Vercel deployment: missing secrets"
            echo "To enable automatic deployment, set:"
            echo "  - VERCEL_TOKEN"
            echo "  - VERCEL_PROJECT_ID"
            echo "  - VERCEL_ORG_ID"
            exit 0
          fi

          echo "Deploying to Vercel..."
          npm install -g vercel

          vercel deploy \
            --token $VERCEL_TOKEN \
            --prod \
            --yes

      - name: Create deployment status
        if: always()
        run: |
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Static output generated" >> $GITHUB_STEP_SUMMARY
          echo "✅ Zero-JavaScript verified" >> $GITHUB_STEP_SUMMARY
          echo "✅ Quality checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: $(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()
    steps:
      - name: Success notification
        if: success()
        run: |
          echo "✅ Deployment to Vercel completed successfully"
          echo ""
          echo "Shallot showcase is now live!"
          echo "Visit: https://shallot.rs (if domain configured)"
          echo ""
          echo "Principles maintained:"
          echo "  ✅ Zero JavaScript"
          echo "  ✅ Type-safe (Rust)"
          echo "  ✅ Accessible (WCAG AA+)"
          echo "  ✅ Beautiful (fluid typography, refined design)"

      - name: Failure notification
        if: failure()
        run: |
          echo "❌ Deployment failed"
          echo "Check the build-and-deploy job for details"
          exit 1
